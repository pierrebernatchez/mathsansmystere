#!/bin/bash
#
# bash trick to obtain a clean absolute path to this script.
pushd `dirname $0` >/dev/null
SCRIPTPATH=`pwd -P`
popd >/dev/null
#
# Duplicate the images to supply identical relative context to tmp .rst files
# Srip each .rst file in the temp directory
# Generate pdf files for the temp context
PROJECTPATH=$(dirname ${SCRIPTPATH})
BASEDIR=$(dirname ${PROJECTPATH})
# Coloring sequenses
COLRED="\e[31m"
COLOFF="\e[0m"
COLGREEN="\e[32m"
#
# Local context
#
UNSTRIPPEDDIR=${PROJECTPATH}/mrst
UNSTRIPPEDIMAGES=${PROJECTPATH}/content/images
#
# Temp context
STRIPPEDDIR=$(mktemp -d)
STRIPPEDRSTFILES=${STRIPPEDDIR}/mrst
STRIPPEDRSTIMAGES=${STRIPPEDDIR}/mrst/images
mkdir ${STRIPPEDRSTFILES}
mkdir ${STRIPPEDRSTIMAGES}
ln ${UNSTRIPPEDIMAGES}/* ${STRIPPEDRSTIMAGES}/
# echo -e ${COLGREEN} 'The temp context images in ' ${COLOFF} ${STRIPPEDRSTIMAGES}/
# ls -l ${STRIPPEDRSTIMAGES}/

#
# target for pdfs
#
RECPDFDIR=${PROJECTPATH}/mpdf
/usr/bin/mkdir -p ${RECPDFDIR}/

#
# Strip to temp context
for afilepath in ${UNSTRIPPEDDIR}/*.rst ; do
    mybasename=${afilepath##*/}
    echo -e ${COLGREEN} 'Stripping' ${COLOFF} ${mybasename} ${COLGREEN} to ${COLOFF} ${STRIPPEDRSTFILES}/${mybasename}
    egrep  -v '^\:.*\:' ${afilepath} > ${STRIPPEDRSTFILES}/${mybasename}
done
for nfilepath in ${STRIPPEDRSTFILES}/*.rst ; do
    # mybasname=$(basename ${nfilepath})
    mybasename=${nfilepath##*/}
    mybasenamenoext=${mybasename%.*}
    echo -e ${COLGREEN} 'Generating ' ${RECPDFDIR}/${mybasenamenoext}.pdf ${COLOFF} 
    rst2pdf --verbose -o ${RECPDFDIR}/${mybasenamenoext}.pdf   < ${STRIPPEDRSTFILES}/${mybasename}
done



# 
# handy_rst_to_pdf -s  ${STRIPPEDRSTFILES}/ -o ${RECPDFDIR}/

# echo -e ${COLGREEN} 'Recursively Removing The temp context ' ${COLOFF} ${STRIPPEDDIR}
# rm -r ${STRIPPEDDIR}



